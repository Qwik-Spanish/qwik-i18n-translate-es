---
title: Qwik City - Adaptador de Cloudflare Pages y Middleware
contributors:
  - adamdbradley
  - manucorporat
  - OzzieOrca
  - himorishige
  - reemardelarosa
  - mhevery
---

# Adaptador de Cloudflare Pages

El adaptador Cloudflare Pages de Qwik City te permite conectar Qwik City a [Cloudflare Pages](https://pages.cloudflare.com/).

## Instalación

Para integrar el adaptador `cloudflare-pages`, utiliza el siguiente comando:

```shell
npm run qwik add cloudflare-pages
```

El adaptador añadirá un nuevo archivo `vite.config.ts` dentro del directorio `adapters/`, y se creará un nuevo archivo de entrada, como este:

```shell
└── adapters/
    └── cloudflare-pages/
        └── vite.config.ts
└── src/
    └── entry.cloudflare-pages.tsx
```

Además, en el archivo `package.json`, se actualizarán los scripts `build.server` y `deploy`.

## Compilación para producción

Para compilar la aplicación para producción, utiliza el siguiente comando, que ejecutará automáticamente `npm run build.server` y `npm run build.client`:

```shell
npm run build
```

[Lee la guía completa aquí](https://github.com/BuilderIO/qwik/tree/main/starters/adapters/cloudflare-pages/README.md)

## Despliegue en Cloudflare Pages

Una vez instalada la integración utilizando `npm run qwik add cloudflare-pages`, el proyecto estará listo para ser desplegado en Cloudflare Pages.

Consulta la [documentación de Cloudflare Pages](https://developers.cloudflare.com/pages/framework-guides/deploy-a-qwik-site/) para obtener más información sobre cómo desplegar tu sitio.

Ten en cuenta que necesitarás una [cuenta de Cloudflare](https://dash.cloudflare.com/sign-up?lang=en-US) para completar este paso.

## Avanzado

### Middleware de Entrada para Cloudflare Pages

Cuando se añade el adaptador `cloudflare-pages`, se creará un nuevo archivo de entrada en `src/entry.cloudflare-pages.tsx`. A continuación se muestra un ejemplo de cómo usar el middleware incorporado en el archivo de entrada.

```tsx title="src/entry.cloudflare-pages.tsx"
import {
  createQwikCity,
  type PlatformCloudflarePages,
} from '@builder.io/qwik-city/middleware/cloudflare-pages';
import qwikCityPlan from '@qwik-city-plan';
import { manifest } from '@qwik-client-manifest';
import render from './entry.ssr';

const fetch = createQwikCity({ render, qwikCityPlan, manifest });

export { fetch };
```

El middleware compilado se generará en el directorio `server/`. Este directorio también contiene un archivo `_worker.js` que implementa el manejo de las peticiones de la aplicación según el [Modo Avanzado de Cloudflare Pages](https://developers.cloudflare.com/pages/platform/functions/advanced-mode/#advanced-mode).
El archivo simplemente reexporta el manejador `fetch` producido, como se muestra a continuación.

```tsx title="/dist/_worker.js"
import { fetch } from "../server/entry.cloudflare-pages";
export default { fetch };
```

- [Fuente del Middleware de Cloudflare Pages](https://github.com/BuilderIO/qwik/tree/main/packages/qwik-city/middleware/cloudflare-pages/index.ts)
- [Modo Avanzado de Cloudflare Pages](https://developers.cloudflare.com/pages/platform/functions/advanced-mode/)
- [Configuración de Rutas de Invocación de Funciones](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes)

### Rutas de Invocación de Funciones de Cloudflare Pages

La configuración de [rutas de invocación de funciones de Cloudflare Page](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes) se puede utilizar para incluir o excluir ciertas rutas para ser utilizadas por las funciones del worker. Tener un archivo `_routes.json` proporciona un control más granular sobre cuándo se invoca su función.

Esto es útil para determinar si la respuesta de una página debe ser renderizada en el lado del servidor (SSR) o si la respuesta debe utilizar un archivo `index.html` generado por el sitio estático (SSG).

Por defecto, el adaptador de Cloudflare Pages _no incluye_ una configuración `public/_routes.json`, sino que se genera automáticamente a partir de la compilación por el adaptador de Cloudflare. Un ejemplo de un archivo `dist/_routes.json` auto-generado sería:

```json
{
  "include": ["/*"],
  "exclude": [
    "/_headers",
    "/_redirects",
    "/build/*",
    "/favicon.ico",
    "/manifest.json",
    "/service-worker.js",
    "/about"
  ],
  "version": 1
}
```

En el ejemplo anterior, se está indicando que _todas_ las páginas deben ser renderizadas en el lado del servidor. Sin embargo, los archivos raíz estáticos como `/favicon.ico` y cualquier activo estático en `/build/*` deben excluirse de las funciones, y en su lugar deben tratarse como un archivo estático.

En la mayoría de los casos, el archivo generado `dist/_routes.json` es ideal. Sin embargo, si necesitas un control más granular sobre cada ruta, puedes proporcionar tu propio archivo `public/_routes.json`. Cuando el proyecto proporciona su propio archivo `public/_routes.json`, el adaptador de Cloudflare no generará automáticamente la configuración de rutas y en su lugar utilizará el que se encuentra en el directorio `public`.

### Contexto

Puedes acceder a las variables de entorno de Cloudflare Page en el parámetro `platform` del método del endpoint:

```ts
export const onRequest = async ({ platform }) => {
  const secret = platform.env['SUPER_SECRET_TOKEN'];
};
```

Además, puedes importar los tipos `RequestHandler` y `PlatformCloudflarePages` para tener completado de tipos en tu editor.

```tsx
import { type RequestHandler } from '@builder.io/qwik-city';
import { type PlatformCloudflarePages } from '@builder.io/qwik-city/middleware/cloudflare-pages';

export const onGet: RequestHandler<PlatformCloudflarePages> = ({ platform }) => {
  //...
};
```
