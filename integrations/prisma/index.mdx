---
title: Qwik City y Prisma
keywords: 'prisma, orm, database, data, storage, postgress, mondodb'
contributors:
  - manucorporat
  - ulic75
---

# Prisma

[Prisma](https://www.prisma.io/) permite la interacción con [MongoDB](https://www.prisma.io/docs/concepts/database-connectors/mongodb) o [bases de datos SQL](https://www.prisma.io/docs/concepts/database-connectors/postgresql) incluyendo tipado seguro.

Con Prisma, defines el esquema de tu base de datos en archivos `.prisma`, y su CLI genera automáticamente las migraciones de la base de datos, así como los tipos de TypeScript.

Prisma puede ser utilizado en Qwik con las funciones `routeLoader$`, `routeAction$` y `server$`. Estas son APIs de Qwik que permiten que el código se ejecute solo en el lado del servidor.

La forma más sencilla de agregar Prisma a Qwik es utilizando el comando `pnpm qwik add prisma`. Esto instalará las dependencias necesarias y creará una carpeta `prisma` con el esquema de Prisma y las migraciones.

```bash
npm run qwik add prisma
```

> Prisma facilita el uso de diferentes bases de datos como Postgres, MySQL, SQLite y MongoDB.


## Listando todos los usuarios

Utilizaremos `routeLoader$` para consultar todos los usuarios en la base de datos, utilizando `prisma.user.findMany()`, y retornaremos el resultado.

```tsx {7} /PrismaClient/ title="src/routes/users/index.tsx"
import { component$ } from '@builder.io/qwik';
import { routeLoader$ } from '@builder.io/qwik-city';
import { PrismaClient } from '@prisma/client'

export const useGetUsers = routeLoader$(async () => {
  const prisma = new PrismaClient();
  const users = await prisma.user.findMany()
  return users;
});

export default component$(() => {
  const users = useGetUsers();
  return (
    <section>
      <h1>Directorio de usuarios</h1>
      <ul>
        {users.value.map(user => (
          <li key={user.id}>
            <a href={`/users/${user.id}`}>{user.name} ({user.email})</a>
          </li>
        ))}
      </ul>
    </section>
  )
});
```

## Mostrando los detalles del usuario

Utilizaremos `routeLoader$` para consultar un usuario específico basado en el parámetro de URL `userId`, utilizando `prisma.user.findUnique()`, y retornaremos el resultado.


```tsx {8} /PrismaClient/ title="src/routes/users/[userId]/index.tsx"
import { component$ } from '@builder.io/qwik';
import { routeLoader$ } from '@builder.io/qwik-city';
import { PrismaClient } from '@prisma/client'

export const useGetUser = routeLoader$(async ({params, status}) => {
  const userId = parseInt(params['userId'], 10);
  const prisma = new PrismaClient();
  const user = await prisma.user.findUnique({where: {id: userId}});
  if (!user) {
    // Establecemos el estado a 404 si el usuario no se encuentra
    status(404);
  }
  return user;
});

export default component$(() => {
  const user = useGetUser();
  return (
    <section>
      <h1>Detalles del usuario</h1>
      {user.value ? (
        <>
          <p>Nombre: {user.value.name}</p>
          <p>Email: {user.value.email}</p>
        </>
      ) : (
        <p>Usuario no encontrado</p>
      )}
    </section>
  )
});
```

## Agregando un usuario

Utilizaremos `routeAction$` y `Form` para crear un formulario progresivo para agregar un nuevo usuario a la base de datos. Utilizaremos `prisma.user.create()` para crear el usuario.

```tsx {7-9} /PrismaClient/ title="src/routes/create/index.tsx"
import { component$ } from '@builder.io/qwik';
import { routeAction$, zod$, z, Form } from '@builder.io/qwik-city';
import { PrismaClient } from '@prisma/client'

export const useCreateUser = routeAction$(async (data) => {
  const prisma = new PrismaClient();
  const user = await prisma.user.create({
    data,
  });
  return user;
}, zod$({
  name: z.string(),
  email: z.string().email(),
}));

export default component$(() => {
  const createUserAction = useCreateUser();
  return (
    <section>
      <h1>Crear Usuario</h1>
      <Form action={createUserAction}>
        <label>Nombre
          <input name="name" value={createUserAction.formData?.get('name')} />
        </label>
        <label>Email
          <input name="email" value={createUserAction.formData?.get('email')} />
        </label>
        <button type="submit">Crear</button>
      </Form>
      {createUserAction.value && (
        <div>
          <h2>¡Usuario creado exitosamente!</h2>
        </div>
      )}
    </section>
  )
});
```

## Limitaciones

### Binario WASM grande

Prisma Client requiere un binario WASM de 14MB que puede ser demasiado grande si planeas implementar tu aplicación en un entorno serverless. Recomendamos utilizar Prisma solo si lo despliegas en un entorno de Node.js, como Google Cloud Run, Express o Azure.

Consulta [este blog para obtener más detalles](https://dev.to/nexxeln/typesafe-database-queries-on-the-edge-5bbn)

### Prisma Client puede no funcionar bien con `pnpm`

La forma en que Prisma genera los tipos de cliente abusa de cómo funcionan los módulos de `npm`, que es diferente de cómo funciona `pnpm`. Recomendamos utilizar `npm` si planeas utilizar Prisma.

